<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="assets/asciinema-player.css" />
  <link rel="stylesheet" type="text/css" href="style.css" />
  <title>2222000022225555</title>
  <link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Pinyon+Script&display=swap">
  <style>

body:not([data-phase="start"]):not([data-phase="pay"]) #signupForm,
body:not([data-phase="pay"]) #payment-element,
body:not([data-phase="sending"]) #sending,
body:not([data-phase="sent"]) #afterSignup {
  display: none;
}

.center-container {
  width: 25vw;
  height: 25vw;
  display: block;
  margin: auto;
  overflow: hidden;
}

#demo {
  /* padding-top: 1.5em; */
}

#signupForm {
  font-size: 2em;
}

#signupForm button {
  font-size: 2rem;
  width: auto;
}

img {
  height: auto;
  max-width: 30%;
  filter: grayscale(40%);
  padding-bottom: 4em;
  border: 10px solid transparent;
  padding: 15px;
  /* margin: 2em; */
  border-image: url(assets/timer.png) 100%;
  padding: 1em;
  margin-top: .8em;
}

#coat {
  border: none !important;
  max-width: 26%;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  /* border: 2px dashed white; */
}

#countdown, #solstice{
  font-size: 1.2em;
    border: 10px solid transparent;
    padding: 15px;
    /* width: fit-content; */
    border-image: url(assets/timer.png) 100%;
    margin: 2em;
}

#countdown {
  margin-top: 1em;
  margin-left: 7em;
  margin-right: 7em;
}

#email {
  border-image: url(assets/timer.png) 100%;
  margin: 1em;
  margin-top: 0em;
  padding-top: 0em;

}

#house {
  width: 22%;
}

@media screen and (max-width : 480px) {
  img {
    height: auto;
    max-width: 80%;
  }

  #house {
  width: 39%;
}


  input {
    width: 200px;
    padding: .2em;
  }

  #email-title {
    font-size: .8em;
  }

  .postscript {
    width: 85%;
  }

  .center-container {
    width: 58vw;
    height: 30vh;
  }

  #signupForm {
    /* margin-top: 2em; */
  }


  #countdown {
  margin-top: 1em;
  margin-left: 1em;
  margin-right: 1em;
}


#coat {
  max-width: 62%;
}






}

</style>
</head>


<body data-phase=start>
  <h1><span class="dfont">RSVP </span>&nbsp;<span><img id="timer-img" src="assets/timer.png"></span> <span span>HEXNYE</span></h1>
  <p> 
    12-31-24 8PM TIL 1-1-25 ‚ô°
    <br>
    ‚ùà Dresscode: <span class="dfont">Timekeeper</span>

    <br>Theme: <span class="dfont">Time does not exist  ‚õû</span><br>
    <u>Free</u> to RSVP til ‚òΩ Dec 15th</u>
    <br>
    Address ‚úú emailed to guests
    <br><br>
    ùÑ¢ Performances by BlackBerry KnuckleDuster, dj Yourszlf, dj Gilly Chan, dj NPC & countdown choir<br>
    Installations by s4y,  m‚ôó‚òΩ‚ùà, & philip errico


  </p>
<!-- <h1>22222‚è≤‚è≤‚è≤‚è≤‚è≤2222255555</h1> -->
<div class="center-container">
  <div id="demo"></div>
</div>


<div id="email">
<form id=signupForm>
  <label><span id="email-title" class="dfont">Your&nbsp;Email:</span> <input name=email type=email required></input></label>
  <div id="payment-element"></div>
  <button class="dfont">Pay $<span id=price>‚Ä¶</span> and RSVP</button>
  <input type=hidden name=paymentIntent></input>
</form>
<div id=sending>
  Sending‚Ä¶
</div>
<div id=afterSignup>
  Thank you for your <span class="dfont">RSVP.<br>You will receive an email soon. </span>&nbsp;<span><img id="timer-img" src="assets/timer.png"></span>
</div>
<p>‚úß All proceeds will go towards artists, firewood, & other event materials ‚úß Price will increase slowly over time ‚úß</p>
<p class="smaller"><i>Send this page to your +1s so they can rsvp</i></p>
</div>

<p class="postscript">
  This website was made by sidney + melanie. Each time someone enters their email above it gets stored in a file on a private digitalocean server. We are gathering your emails so that we can write to you with more details about the evening as time counts down. We have separated your email information from our payment processor. On&nbsp;1&#8288;-&#8288;1&#8288;-&#8288;2025 all your emails in this file will be deleted.
  <br>
  If you have any questions or would like to be part of organizing/performing, reach out to us at hexhousenyc@gmail.com ‚úú   
</p>
<h1>Call for Coats!</h1> 
<img id="coat" src="assets/coat.png">
<p class="postscript">
  <!-- <h1>Call for coats!</h1> -->
  This event is also a coat drive. Please bring your coats you no longer need so that they can be donated to <a href="https://nnccc.org/"><i>Nuestros Ninos Child Development Center</i></a> our local dropoff location.
</p>

<h1>Call for videos!</h1> 
<img id="coat" src="assets/poster.gif">
<p class="postscript">
  Share videos relating to countdowns, measuring time, and time's nonexistance <i><a href="/countdownvideos.html">here</a></i>. These will become part of an installation in the space.
</p>

<h1>Covid Precautions</h1>
<img id="coat" src="assets/light.jpg">
<p>We were graciously loaned two <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10684113/">UVC sanitizing lights</a> to improve the air quality through the evening. There will also be an outside area with a bonfire.</p>

<img src="assets/ca.png">
<br>
<img id="house" src="assets/house3.png">

<div id="solstice">
  <div id="num">---</div>
  <span class="dfont">milliseconds</span><br>
  TIL <span class="dfont">Solstice</span>
</div>

</div>
<div id="countdown">
  <div id="num">---</div>
  <span class="dfont">milliseconds</span><br>
  TIL <span class="dfont">2025:</span>
</div>

<script>



function makeCountdown(el, targetDate, onEnd) {
  const targetTime = +targetDate;
  const countNode = el.firstChild;

  let animationFrame;

  const updateTimer = () => {
    const now = Date.now();
    const distance = targetTime - now;

    countNode.nodeValue = distance;

    if (distance < 0) {
      onEnd();
    } else {
      animationFrame = requestAnimationFrame(updateTimer);
    }
  };

  const obs = new IntersectionObserver(entries => {
    cancelAnimationFrame(animationFrame);
    if (entries[0].isIntersecting)
      updateTimer();
  });
  obs.observe(el);

  updateTimer();
}

makeCountdown(countdown.querySelector('#num'), new Date("January 1, 2025 00:00:00 EST"), () => {
  document.getElementById("countdown").textContent = "Happy 2222000022225555";
});

makeCountdown(solstice.querySelector('#num'), new Date("December 21, 2024 04:19:00 EST"), () => {
  document.getElementById("solstice").textContent = "·≥Ä Happy solstice ·≥Ä";
});

</script>
  <script src="assets/asciinema-player.min.js"></script>
  <script>
    AsciinemaPlayer.create('assets/10.cast', document.getElementById('demo'), {
      speed: 2,
      idleTimeLimit: 1,
      autoPlay: true,
      loop: true,
      preload: true,
      controls: false,
      cols: 57,
      rows: 26,
      // terminalFontSize: "big",
      // fit: "both",
      startAt: 4,
      theme: 'bla',

    });
  </script>
  <script type=module>

    let stripe, elements, paymentElement;
    let stripeKey;
    let quotedPrice;

    let paymentDeets = fetch("/pay/deets").then(r => r.json());

    paymentDeets.then(deets => {
      stripeKey = deets.stripeKey;
    });

    const updatePrice = async () => {
      const { priceRange } = await paymentDeets;
      const { start, end, exp } = priceRange;

      const where = Math.pow((Date.now() - start.time) / (end.time - start.time), exp);
      const interpPrice = Math.floor(start.price + (end.price - start.price) * where);

      if (quotedPrice == interpPrice)
        return;

      quotedPrice = interpPrice;
      if (elements)
        elements.update({ amount: quotedPrice });
      price.textContent = (interpPrice / 100).toFixed(2);
    };

    setInterval(updatePrice, 1000);
    updatePrice();

    const loadStripe = async () => {
      const scriptEl = document.createElement('script');
      const loadPromise = new Promise(r => scriptEl.onload = r);
      scriptEl.src = "https://js.stripe.com/v3/";
      document.body.appendChild(scriptEl);
      await loadPromise;
      stripe = Stripe(stripeKey);

      elements = stripe.elements({
        mode: 'payment',
        amount: quotedPrice,
        currency: 'usd',
        appearance: {
          theme: 'night',
        },
      });
      paymentElement = elements.create('payment', { layout: 'accordion'});
      paymentElement.mount('#payment-element');
    };

    signupForm.addEventListener('submit', async e => {
      e.preventDefault();

      const submitBtn = signupForm.querySelector('button');
      const onError = err => {
        console.log(err);
        document.body.dataset.phase = 'pay';
        submitBtn.disabled = false;
      };

      if (document.body.dataset.phase == 'pay') {
        if (submitBtn.disabled)
          return;
        submitBtn.disabled = true;

        {
          const {error} = await elements.submit();
          if (error)
            return onError(error);
        }

        document.body.dataset.phase = 'sending';

        let paymentIntent;
        try {
          paymentIntent = await (await fetch("/pay/new", {
            method: 'POST',
            body: new FormData(e.target),
          })).json();
        } catch (e) {
          return onError(error);
        }

        // Bail if the server-side price is > 5¬¢ away from our last-displayed price. Don't trust the server :-)
        if (Math.abs(paymentIntent.price - quotedPrice) > 5) {
          return onError(`Client side price (${quotedPrice}) too different from server-side price (${paymentIntent.price})`);
        }

        signupForm.elements.paymentIntent.value = paymentIntent.client_secret;

        await fetch("/register", {
          method: 'POST',
          body: new FormData(signupForm),
        });

        {
          const {error} = await stripe.confirmPayment({
            elements, 
            clientSecret: paymentIntent.client_secret,
            confirmParams: {
              return_url: new URL('/?return_from_payment', location).href,
            },
            redirect: "if_required",
          });
          if (error)
            return onError(error);
        }
        
        document.body.dataset.phase = 'sent';
        afterSignup.scrollIntoView({
          block: 'center',
        });

        return;
      }

      document.body.dataset.phase = 'sending';
      await loadStripe();
      document.body.dataset.phase = 'pay';
    });

  </script>
